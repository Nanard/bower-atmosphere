!function(e,n){"function"==typeof define&&define.amd?define(n):e.atmosphere=n()}(this,function(){"use strict";var e,n="2.1.6-javascript",t={},o=[],r=[],i=0,a=Object.prototype.hasOwnProperty;return t={onError:function(){},onClose:function(){},onOpen:function(){},onReopen:function(){},onMessage:function(){},onReconnect:function(){},onMessagePublished:function(){},onTransportFailure:function(){},onLocalMessage:function(){},onFailureToReconnect:function(){},onClientTimeout:function(){},AtmosphereRequest:function(e){function o(){mn=!0,vn=!1,hn=0,un=null,dn=null,fn=null,pn=null}function a(){u(),o()}function s(e,n){""===cn.partialMessage&&"streaming"===n.transport&&e.responseText.length>n.maxStreamingLength&&(cn.messages=[],n.reconnectingOnLength=!0,n.isReopen=!0,tn(!0),l(),u(),D(e,n,n.pollingInterval))}function l(){if(ln.enableProtocol&&!ln.firstMessage){var e="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+ln.uuid;t.util.each(ln.headers,function(n,o){var r=t.util.isFunction(o)?o.call(this,ln,ln,cn):o;null!=r&&(e+="&"+encodeURIComponent(n)+"="+encodeURIComponent(r))});var n=ln.url.replace(/([?&])_=[^&]*/,e);n+=n===ln.url?(/\?/.test(ln.url)?"&":"?")+e:"";var o={connected:!1},r=new t.AtmosphereRequest(o);r.attachHeadersAsQueryString=!1,r.dropHeaders=!0,r.url=n,r.contentType="text/plain",r.transport="polling",r.method="GET",r.data="",r.async=!1,J("",r)}}function c(){ln.reconnectId&&(clearTimeout(ln.reconnectId),delete ln.reconnectId),ln.reconnect=!1,vn=!0,cn.request=ln,cn.state="unsubscribe",cn.responseBody="",cn.status=408,cn.partialMessage="",on(),l(),u()}function u(){cn.partialMessage="",ln.id&&clearTimeout(ln.id),null!=pn&&(pn.close(),pn=null),null!=gn&&(gn.abort(),gn=null),null!=fn&&(fn.abort(),fn=null),null!=un&&(un.canSendMessage&&un.close(),un=null),null!=dn&&(dn.close(),dn=null),d()}function d(){null!=rn&&(clearInterval(an),document.cookie=sn+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",rn.signal("close",{reason:"",heir:vn?(rn.get("children")||[])[0]:yn}),rn.close()),null!=wn&&wn.close()}function f(e){a(),ln=t.util.extend(ln,e),ln.mrequest=ln.reconnect,ln.reconnect||(ln.reconnect=!0)}function p(){return null!=ln.webSocketImpl||window.WebSocket||window.MozWebSocket}function g(){return window.EventSource}function m(){if(ln.shared){if(wn=h(ln),null!=wn&&("debug"===ln.logLevel&&t.util.debug("Storage service available. All communication will be local"),wn.open(ln)))return;"debug"===ln.logLevel&&t.util.debug("No Storage service available."),wn=null}ln.firstMessage=0==i?!0:!1,ln.isOpen=!1,ln.ctime=t.util.now(),0===ln.uuid&&(ln.uuid=i),cn.closedByClientTimeout=!1,"websocket"!==ln.transport&&"sse"!==ln.transport?q(ln):"websocket"===ln.transport?p()?R(!1):U("Websocket is not supported, using request.fallbackTransport ("+ln.fallbackTransport+")"):"sse"===ln.transport&&(g()?k(!1):U("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+ln.fallbackTransport+")"))}function h(e){function n(e,n){var t,o=e.length;for(t=0;o>t;t++)e[t]===n&&e.splice(t,1);return o!==e.length}function o(n){var o=t.util.parseJSON(n),r=o.data;if("c"===o.target)switch(o.type){case"open":b("opening","local",ln);break;case"close":s||(s=!0,"aborted"===r.reason?c():r.heir===yn?m():setTimeout(function(){m()},100));break;case"message":Y(r,"messageReceived",200,e.transport);break;case"localMessage":_(r)}}function r(){var e=new RegExp("(?:^|; )("+encodeURIComponent(l)+")=([^;]*)").exec(document.cookie);return e?t.util.parseJSON(decodeURIComponent(e[2])):void 0}var i,a,s,l="atmosphere-"+e.url,u={storage:function(){function r(e){e.key===l&&e.newValue&&o(e.newValue)}if(t.util.storage){var i=window.localStorage,a=function(e){return t.util.parseJSON(i.getItem(l+"-"+e))},s=function(e,n){i.setItem(l+"-"+e,t.util.stringifyJSON(n))};return{init:function(){return s("children",a("children").concat([yn])),t.util.on(window,"storage",r),a("opened")},signal:function(e,n){i.setItem(l,t.util.stringifyJSON({target:"p",type:e,data:n}))},close:function(){var o=a("children");t.util.off(window,"storage",r),o&&n(o,e.id)&&s("children",o)}}}},windowref:function(){var e=window.open("",l.replace(/\W/g,""));if(e&&!e.closed&&e.callbacks)return{init:function(){return e.callbacks.push(o),e.children.push(yn),e.opened},signal:function(n,o){!e.closed&&e.fire&&e.fire(t.util.stringifyJSON({target:"p",type:n,data:o}))},close:function(){s||(n(e.callbacks,o),n(e.children,yn))}}}};return i=r(),!i||t.util.now()-i.ts>1e3||!(a=u.storage()||u.windowref())?void 0:{open:function(){var n;return an=setInterval(function(){var e=i;i=r(),i&&e.ts!==i.ts||o(t.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),n=a.init(),n&&setTimeout(function(){b("opening","local",e)},50),n},send:function(e){a.signal("send",e)},localSend:function(e){a.signal("localSend",t.util.stringifyJSON({id:yn,event:e}))},close:function(){vn||(clearInterval(an),a.signal("close"),a.close())}}}function v(){function e(e){var n=t.util.parseJSON(e),o=n.data;if("p"===n.target)switch(n.type){case"send":j(o);break;case"localSend":_(o);break;case"close":c()}}function n(){document.cookie=sn+"="+encodeURIComponent(t.util.stringifyJSON({ts:t.util.now()+1,heir:(o.get("children")||[])[0]}))+"; path=/"}var o,r="atmosphere-"+ln.url,i={storage:function(){function n(n){n.key===r&&n.newValue&&e(n.newValue)}if(t.util.storage){var o=window.localStorage;return{init:function(){t.util.on(window,"storage",n)},signal:function(e,n){o.setItem(r,t.util.stringifyJSON({target:"c",type:e,data:n}))},get:function(e){return t.util.parseJSON(o.getItem(r+"-"+e))},set:function(e,n){o.setItem(r+"-"+e,t.util.stringifyJSON(n))},close:function(){t.util.off(window,"storage",n),o.removeItem(r),o.removeItem(r+"-opened"),o.removeItem(r+"-children")}}}},windowref:function(){var n,o=r.replace(/\W/g,""),i=document.getElementById(o);return i||(i=document.createElement("div"),i.id=o,i.style.display="none",i.innerHTML='<iframe name="'+o+'" />',document.body.appendChild(i)),n=i.firstChild.contentWindow,{init:function(){n.callbacks=[e],n.fire=function(e){var t;for(t=0;t<n.callbacks.length;t++)n.callbacks[t](e)}},signal:function(e,o){!n.closed&&n.fire&&n.fire(t.util.stringifyJSON({target:"c",type:e,data:o}))},get:function(e){return n.closed?null:n[e]},set:function(e,t){n.closed||(n[e]=t)},close:function(){}}}};bn=function(e){o.signal("message",e)},o=i.storage()||i.windowref(),o.init(),"debug"===ln.logLevel&&t.util.debug("Installed StorageService "+o),o.set("children",[]),null==o.get("opened")||o.get("opened")||o.set("opened",!1),sn=encodeURIComponent(r),n(),an=setInterval(n,1e3),rn=o}function b(e,n,t){if(ln.shared&&"local"!==n&&v(),null!=rn&&rn.set("opened",!0),t.close=function(){c()},hn>0&&"re-connecting"===e)t.isReopen=!0,E(cn);else if(null==cn.error){cn.request=t;var o=cn.state;cn.state=e;var r=cn.transport;cn.transport=n;var i=cn.responseBody;on(),cn.responseBody=i,cn.state=o,cn.transport=r}}function w(e){e.transport="jsonp";var n,o=ln;null!=e&&"undefined"!=typeof e&&(o=e),gn={open:function(){function r(){var t=o.url;null!=o.dispatchUrl&&(t+=o.dispatchUrl);var r=o.data;o.attachHeadersAsQueryString&&(t=B(o),""!==r&&(t+="&X-Atmosphere-Post-Body="+encodeURIComponent(r)),r="");var a=document.head||document.getElementsByTagName("head")[0]||document.documentElement;n=document.createElement("script"),n.src=t+"&jsonpTransport="+i,n.clean=function(){n.clean=n.onerror=n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n)},n.onload=n.onreadystatechange=function(){(!n.readyState||/loaded|complete/.test(n.readyState))&&n.clean()},n.onerror=function(){n.clean(),o.lastIndex=0,o.openId&&clearTimeout(o.openId),o.reconnect&&hn++<o.maxReconnectOnClose?(b("re-connecting",o.transport,o),D(gn,o,e.reconnectInterval),o.openId=setTimeout(function(){M(o)},o.reconnectInterval+1e3)):O(0,"maxReconnectOnClose reached")},a.insertBefore(n,a.firstChild)}var i="atmosphere"+ ++yn;window[i]=function(e){if(o.reconnect)if(-1===o.maxRequest||o.requestCount++<o.maxRequest){if(o.executeCallbackBeforeReconnect||D(gn,o,o.pollingInterval),null!=e&&"string"!=typeof e)try{e=e.message}catch(n){}var r=L(e,o,cn);r||Y(cn.responseBody,"messageReceived",200,o.transport),o.executeCallbackBeforeReconnect&&D(gn,o,o.pollingInterval)}else t.util.log(ln.logLevel,["JSONP reconnect maximum try reached "+ln.requestCount]),O(0,"maxRequest reached")},setTimeout(function(){r()},50)},abort:function(){n&&n.clean&&n.clean()}},gn.open()}function y(e){return null!=ln.webSocketImpl?ln.webSocketImpl:window.WebSocket?new WebSocket(e):new MozWebSocket(e)}function S(){return B(ln,t.util.getAbsoluteURL(ln.webSocketUrl||ln.url)).replace(/^http/,"ws")}function T(){var e=B(ln);return e}function k(e){cn.transport="sse";var n=T();if("debug"===ln.logLevel&&(t.util.debug("Invoking executeSSE"),t.util.debug("Using URL: "+n)),ln.enableProtocol&&e){var o=t.util.now()-ln.ctime;ln.lastTimestamp=Number(ln.stime)+Number(o)}if(e&&!ln.reconnect)return void(null!=dn&&u());try{dn=new EventSource(n,{withCredentials:ln.withCredentials})}catch(r){return O(0,r),void U("SSE failed. Downgrading to fallback transport and resending")}ln.connectTimeout>0&&(ln.id=setTimeout(function(){e||u()},ln.connectTimeout)),dn.onopen=function(){x(ln),"debug"===ln.logLevel&&t.util.debug("SSE successfully opened"),ln.enableProtocol?ln.isReopen&&(ln.isReopen=!1,b("re-opening",ln.transport,ln)):e?b("re-opening","sse",ln):b("opening","sse",ln),e=!0,"POST"===ln.method&&(cn.state="messageReceived",dn.send(ln.data))},dn.onmessage=function(e){if(x(ln),!ln.enableXDR&&e.origin&&e.origin!==window.location.protocol+"//"+window.location.host)return void t.util.log(ln.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]);cn.state="messageReceived",cn.status=200,e=e.data;var n=L(e,ln,cn);n||(on(),cn.responseBody="",cn.messages=[])},dn.onerror=function(){clearTimeout(ln.id),cn.closedByClientTimeout||(tn(e),u(),vn?t.util.log(ln.logLevel,["SSE closed normally"]):e?ln.reconnect&&"sse"===cn.transport&&(hn++<ln.maxReconnectOnClose?(b("re-connecting",ln.transport,ln),ln.reconnectInterval>0?ln.reconnectId=setTimeout(function(){k(!0)},ln.reconnectInterval):k(!0),cn.responseBody="",cn.messages=[]):(t.util.log(ln.logLevel,["SSE reconnect maximum try reached "+hn]),O(0,"maxReconnectOnClose reached"))):U("SSE failed. Downgrading to fallback transport and resending"))}}function R(e){if(cn.transport="websocket",ln.enableProtocol&&e){var n=t.util.now()-ln.ctime;ln.lastTimestamp=Number(ln.stime)+Number(n)}var o=S(ln.url);if("debug"===ln.logLevel&&(t.util.debug("Invoking executeWebSocket"),t.util.debug("Using URL: "+o)),e&&!ln.reconnect)return void(null!=un&&u());un=y(o),null!=ln.webSocketBinaryType&&(un.binaryType=ln.webSocketBinaryType),ln.connectTimeout>0&&(ln.id=setTimeout(function(){if(e);else{var n={code:1002,reason:"",wasClean:!1};un.onclose(n);try{u()}catch(t){}}},ln.connectTimeout)),un.onopen=function(){x(ln),"debug"===ln.logLevel&&t.util.debug("Websocket successfully opened");var n=e;null!=un&&(un.canSendMessage=!0),ln.enableProtocol||(e=!0,n?b("re-opening","websocket",ln):b("opening","websocket",ln)),null!=un&&"POST"===ln.method&&(cn.state="messageReceived",un.send(ln.data))},un.onmessage=function(n){x(ln),ln.enableProtocol&&(e=!0),cn.state="messageReceived",cn.status=200,n=n.data;var t="string"==typeof n;if(t){var o=L(n,ln,cn);o||(on(),cn.responseBody="",cn.messages=[])}else{if(!C(ln,n))return;cn.responseBody=n,on(),cn.responseBody=null}},un.onerror=function(){clearTimeout(ln.id)},un.onclose=function(n){if(clearTimeout(ln.id),"closed"!==cn.state){var o=n.reason;if(""===o)switch(n.code){case 1e3:o="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:o="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:o="The endpoint is terminating the connection due to a protocol error.";break;case 1003:o="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:o="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:o="Unknown: no status code was provided even though one was expected.";break;case 1006:o="Connection was closed abnormally (that is, with no close frame being sent)."}"warn"===ln.logLevel&&(t.util.warn("Websocket closed, reason: "+o),t.util.warn("Websocket closed, wasClean: "+n.wasClean)),cn.closedByClientTimeout||(tn(e),cn.state="closed",vn?t.util.log(ln.logLevel,["Websocket closed normally"]):e?ln.reconnect&&"websocket"===cn.transport&&(u(),hn++<ln.maxReconnectOnClose?(b("re-connecting",ln.transport,ln),ln.reconnectInterval>0?ln.reconnectId=setTimeout(function(){cn.responseBody="",cn.messages=[],R(!0)},ln.reconnectInterval):(cn.responseBody="",cn.messages=[],R(!0))):(t.util.log(ln.logLevel,["Websocket reconnect maximum try reached "+ln.requestCount]),"warn"===ln.logLevel&&t.util.warn("Websocket error, reason: "+n.reason),O(0,"maxReconnectOnClose reached"))):U("Websocket failed. Downgrading to Comet and resending"))}};var r=navigator.userAgent.toLowerCase(),i=r.indexOf("android")>-1;i&&void 0===un.url&&un.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function C(e,n){var o=!0;if("polling"===e.transport)return o;if(0!==t.util.trim(n).length&&e.enableProtocol&&e.firstMessage){e.firstMessage=!1;var r=n.split(e.messageDelimiter),a=2===r.length?0:1;e.uuid=t.util.trim(r[a]),e.stime=t.util.trim(r[a+1]),o=!1,"long-polling"!==e.transport&&M(e),i=e.uuid}else e.enableProtocol&&e.firstMessage&&t.util.browser.msie&&+t.util.browser.version.split(".")[0]<10?o=!1:M(e);return o}function x(e){clearTimeout(e.id),e.timeout>0&&"polling"!==e.transport&&(e.id=setTimeout(function(){I(e),l(),u()},e.timeout))}function I(){cn.closedByClientTimeout=!0,cn.state="closedByClient",cn.responseBody="",cn.status=408,cn.messages=[],on()}function O(e,n){u(),clearTimeout(ln.id),cn.state="error",cn.reasonPhrase=n,cn.responseBody="",cn.status=e,cn.messages=[],on()}function L(e,n,o){if(!C(n,e))return!0;if(0===e.length)return!0;if(n.trackMessageLength){e=o.partialMessage+e;for(var r=[],i=e.indexOf(n.messageDelimiter);-1!==i;){var a=t.util.trim(e.substring(0,i)),s=+a;if(isNaN(s))throw new Error('message length "'+a+'" is not a number');i+=n.messageDelimiter.length,i+s>e.length?i=-1:(r.push(e.substring(i,i+s)),e=e.substring(i+s,e.length),i=e.indexOf(n.messageDelimiter))}return o.partialMessage=e,0!==r.length?(o.responseBody=r.join(n.messageDelimiter),o.messages=r,!1):(o.responseBody="",o.messages=[],!0)}return o.responseBody=e,!1}function U(e){t.util.log(ln.logLevel,[e]),"undefined"!=typeof ln.onTransportFailure?ln.onTransportFailure(e,ln):"undefined"!=typeof t.util.onTransportFailure&&t.util.onTransportFailure(e,ln),ln.transport=ln.fallbackTransport;var n=-1===ln.connectTimeout?0:ln.connectTimeout;ln.reconnect&&"none"!==ln.transport||null==ln.transport?(ln.method=ln.fallbackMethod,cn.transport=ln.fallbackTransport,ln.fallbackTransport="none",n>0?ln.reconnectId=setTimeout(function(){m()},n):m()):O(500,"Unable to reconnect with fallback transport")}function B(e,o){var r=ln;return null!=e&&"undefined"!=typeof e&&(r=e),null==o&&(o=r.url),r.attachHeadersAsQueryString?-1!==o.indexOf("X-Atmosphere-Framework")?o:(o+=-1!==o.indexOf("?")?"&":"?",o+="X-Atmosphere-tracking-id="+r.uuid,o+="&X-Atmosphere-Framework="+n,o+="&X-Atmosphere-Transport="+r.transport,r.trackMessageLength&&(o+="&X-Atmosphere-TrackMessageSize=true"),o+=null!=r.lastTimestamp?"&X-Cache-Date="+r.lastTimestamp:"&X-Cache-Date=0",""!==r.contentType&&(o+="&Content-Type="+("websocket"===r.transport?r.contentType:encodeURIComponent(r.contentType))),r.enableProtocol&&(o+="&X-atmo-protocol=true"),t.util.each(r.headers,function(n,i){var a=t.util.isFunction(i)?i.call(this,r,e,cn):i;null!=a&&(o+="&"+encodeURIComponent(n)+"="+encodeURIComponent(a))}),o):o}function M(e){e.isOpen?e.isReopen&&(e.isReopen=!1,b("re-opening",e.transport,e)):(e.isOpen=!0,b("opening",e.transport,e))}function q(e){var n=ln;if((null!=e||"undefined"!=typeof e)&&(n=e),n.lastIndex=0,n.readyState=0,"jsonp"===n.transport||n.enableXDR&&t.util.checkCORSSupport())return void w(n);if(t.util.browser.msie&&+t.util.browser.version.split(".")[0]<10){if("streaming"===n.transport)return void(n.enableXDR&&window.XDomainRequest?N(n):H(n));if(n.enableXDR&&window.XDomainRequest)return void N(n)}var o=function(){n.lastIndex=0,n.reconnect&&hn++<n.maxReconnectOnClose?(b("re-connecting",e.transport,e),D(r,n,e.reconnectInterval)):O(0,"maxReconnectOnClose reached")};if(n.force||n.reconnect&&(-1===n.maxRequest||n.requestCount++<n.maxRequest)){n.force=!1;var r=t.util.xhr();r.hasData=!1,A(r,n,!0),n.suspend&&(fn=r),"polling"!==n.transport&&(cn.transport=n.transport,r.onabort=function(){tn(!0)},r.onerror=function(){cn.error=!0;try{cn.status=XMLHttpRequest.status}catch(e){cn.status=500}cn.status||(cn.status=500),cn.errorHandled||(u(),o())}),r.onreadystatechange=function(){if(!vn){cn.error=null;var i=!1,a=!1;if("streaming"===n.transport&&n.readyState>2&&4===r.readyState){if(n.reconnectingOnLength)return;return u(),void o()}if(n.readyState=r.readyState,"streaming"===n.transport&&r.readyState>=3?a=!0:"long-polling"===n.transport&&4===r.readyState&&(a=!0),x(ln),"polling"!==n.transport){var l=200;if(4===r.readyState&&(l=r.status>1e3?0:r.status),l>=300||0===l)return cn.errorHandled=!0,u(),void o();n.enableProtocol&&e.firstMessage||2!==r.readyState||M(n)}else 4===r.readyState&&(a=!0);if(a){var c=r.responseText;if(0===t.util.trim(c).length&&"long-polling"===n.transport)return void(r.hasData?r.hasData=!1:D(r,n,n.pollingInterval));if(r.hasData=!0,Z(r,ln),"streaming"===n.transport)if(t.util.browser.opera)t.util.iterate(function(){if(500!==cn.status&&r.responseText.length>n.lastIndex){try{cn.status=r.status,cn.headers=t.util.parseHeaders(r.getAllResponseHeaders()),Z(r,ln)}catch(e){cn.status=404}x(ln),cn.state="messageReceived";var o=r.responseText.substring(n.lastIndex);n.lastIndex=r.responseText.length,i=L(o,n,cn),i||on(),s(r,n)}else if(cn.status>400)return n.lastIndex=r.responseText.length,!1},0);else{var d=c.substring(n.lastIndex,c.length);if(i=L(d,n,cn),n.lastIndex=c.length,i)return}else i=L(c,n,cn);try{cn.status=r.status,cn.headers=t.util.parseHeaders(r.getAllResponseHeaders()),Z(r,n)}catch(f){cn.status=404}cn.state=n.suspend?0===cn.status?"closed":"messageReceived":"messagePublished";var p="streaming"!==e.transport&&"polling"!==e.transport;p&&!n.executeCallbackBeforeReconnect&&D(r,n,n.pollingInterval),0===cn.responseBody.length||i||on(),p&&n.executeCallbackBeforeReconnect&&D(r,n,n.pollingInterval),s(r,n)}}};try{r.send(n.data),mn=!0}catch(i){t.util.log(n.logLevel,["Unable to connect to "+n.url]),O(0,i)}}else"debug"===n.logLevel&&t.util.log(n.logLevel,["Max re-connection reached."]),O(0,"maxRequest reached")}function A(e,n,o){var r=n.url;null!=n.dispatchUrl&&"POST"===n.method&&(r+=n.dispatchUrl),r=B(n,r),r=t.util.prepareURL(r),o&&(e.open(n.method,r,n.async),n.connectTimeout>0&&(n.id=setTimeout(function(){0===n.requestCount&&(u(),Y("Connect timeout","closed",200,n.transport))},n.connectTimeout))),ln.withCredentials&&"withCredentials"in e&&(e.withCredentials=!0),ln.dropHeaders||(e.setRequestHeader("X-Atmosphere-Framework",t.util.version),e.setRequestHeader("X-Atmosphere-Transport",n.transport),null!=n.lastTimestamp?e.setRequestHeader("X-Cache-Date",n.lastTimestamp):e.setRequestHeader("X-Cache-Date",0),n.trackMessageLength&&e.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),e.setRequestHeader("X-Atmosphere-tracking-id",n.uuid),t.util.each(n.headers,function(r,i){var a=t.util.isFunction(i)?i.call(this,e,n,o,cn):i;null!=a&&e.setRequestHeader(r,a)})),""!==n.contentType&&e.setRequestHeader("Content-Type",n.contentType)}function D(e,n,t){if(n.reconnect||n.suspend&&mn){var o=0;e&&e.readyState>1&&(o=e.status>1e3?0:e.status),cn.status=0===o?204:o,cn.reason=0===o?"Server resumed the connection or down.":"OK",clearTimeout(n.id),n.reconnectId&&(clearTimeout(n.reconnectId),delete n.reconnectId),t>0?ln.reconnectId=setTimeout(function(){q(n)},t):q(n)}}function E(e){e.state="re-connecting",en(e)}function N(e){"polling"!==e.transport?(pn=P(e),pn.open()):P(e).open()}function P(e){var n=ln;null!=e&&"undefined"!=typeof e&&(n=e);var o=n.transport,r=0,i=new window.XDomainRequest,a=function(){"long-polling"===n.transport&&n.reconnect&&(-1===n.maxRequest||n.requestCount++<n.maxRequest)&&(i.status=200,N(n))},s=n.rewriteURL||function(e){var n=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(n&&n[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+n[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+n[2]+"&").replace(/&$/,"")}return e};i.onprogress=function(){l(i)},i.onerror=function(){"polling"!==n.transport&&(u(),hn++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){b("re-connecting",e.transport,e),N(n)},n.reconnectInterval):(b("re-connecting",e.transport,e),N(n)):O(0,"maxReconnectOnClose reached"))},i.onload=function(){};var l=function(e){clearTimeout(n.id);var i=e.responseText;if(i=i.substring(r),r+=i.length,"polling"!==o){x(n);var s=L(i,n,cn);if("long-polling"===o&&0===t.util.trim(i).length)return;n.executeCallbackBeforeReconnect&&a(),s||Y(cn.responseBody,"messageReceived",200,o),n.executeCallbackBeforeReconnect||a()}};return{open:function(){var e=n.url;null!=n.dispatchUrl&&(e+=n.dispatchUrl),e=B(n,e),i.open(n.method,s(e)),"GET"===n.method?i.send():i.send(n.data),n.connectTimeout>0&&(n.id=setTimeout(function(){0===n.requestCount&&(u(),Y("Connect timeout","closed",200,n.transport))},n.connectTimeout))},close:function(){i.abort()}}}function H(e){pn=X(e),pn.open()}function X(e){var n=ln;null!=e&&"undefined"!=typeof e&&(n=e);var o,r=new window.ActiveXObject("htmlfile");r.open(),r.close();var i=n.url;return null!=n.dispatchUrl&&(i+=n.dispatchUrl),"polling"!==n.transport&&(cn.transport=n.transport),{open:function(){var e=r.createElement("iframe");i=B(n),""!==n.data&&(i+="&X-Atmosphere-Post-Body="+encodeURIComponent(n.data)),i=t.util.prepareURL(i),e.src=i,r.body.appendChild(e);var a=e.contentDocument||e.contentWindow.document;o=t.util.iterate(function(){try{if(!a.firstChild)return;var e=a.body?a.body.lastChild:a,i=function(){var n=e.cloneNode(!0);n.appendChild(a.createTextNode("."));var t=n.innerText;return t=t.substring(0,t.length-1)};if(!a.body||!a.body.firstChild||"pre"!==a.body.firstChild.nodeName.toLowerCase()){var s=a.head||a.getElementsByTagName("head")[0]||a.documentElement||a,l=a.createElement("script");l.text="document.write('<plaintext>')",s.insertBefore(l,s.firstChild),s.removeChild(l),e=a.body.lastChild}return n.closed&&(n.isReopen=!0),o=t.util.iterate(function(){var t=i();if(t.length>n.lastIndex){x(ln),cn.status=200,cn.error=null,e.innerText="";var o=L(t,n,cn);if(o)return"";Y(cn.responseBody,"messageReceived",200,n.transport)}return n.lastIndex=0,"complete"===a.readyState?(tn(!0),b("re-connecting",n.transport,n),n.reconnectInterval>0?n.reconnectId=setTimeout(function(){H(n)},n.reconnectInterval):H(n),!1):void 0},null),!1}catch(c){return cn.error=!0,b("re-connecting",n.transport,n),hn++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){H(n)},n.reconnectInterval):H(n):O(0,"maxReconnectOnClose reached"),r.execCommand("Stop"),r.close(),!1}})},close:function(){o&&o(),r.execCommand("Stop"),tn(!0)}}}function j(e){null!=wn?F(e):null!=fn||null!=dn?$(e):null!=pn?z(e):null!=gn?G(e):null!=un?K(e):(O(0,"No suspended connection available"),t.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before invoking this method"))}function J(e,n){n||(n=V(e)),n.transport="polling",n.method="GET",n.async=!1,n.withCredentials=!1,n.reconnect=!1,n.force=!0,n.suspend=!1,n.timeout=1e3,q(n)}function F(e){wn.send(e)}function W(e){if(0!==e.length)try{wn?wn.localSend(e):rn&&rn.signal("localMessage",t.util.stringifyJSON({id:yn,event:e}))}catch(n){t.util.error(n)}}function $(e){var n=V(e);q(n)}function z(e){if(ln.enableXDR&&t.util.checkCORSSupport()){var n=V(e);n.reconnect=!1,w(n)}else $(e)}function G(e){$(e)}function Q(e){var n=e;return"object"==typeof n&&(n=e.data),n}function V(e){var n=Q(e),o={connected:!1,timeout:6e4,method:"POST",url:ln.url,contentType:ln.contentType,headers:ln.headers,reconnect:!0,callback:null,data:n,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:ln.withCredentials,async:ln.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:ln.enableXDR,uuid:ln.uuid,dispatchUrl:ln.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",maxReconnectOnClose:ln.maxReconnectOnClose};return"object"==typeof e&&(o=t.util.extend(o,e)),o}function K(e){var n,o=t.util.isBinary(e)?e:Q(e);try{if(n=null!=ln.dispatchUrl?ln.webSocketPathDelimiter+ln.dispatchUrl+ln.webSocketPathDelimiter+o:o,!un.canSendMessage)return void t.util.error("WebSocket not connected.");un.send(n)}catch(r){un.onclose=function(){},u(),U("Websocket failed. Downgrading to Comet and resending "+e),$(e)}}function _(e){var n=t.util.parseJSON(e);n.id!==yn&&("undefined"!=typeof ln.onLocalMessage?ln.onLocalMessage(n.event):"undefined"!=typeof t.util.onLocalMessage&&t.util.onLocalMessage(n.event))}function Y(e,n,t,o){cn.responseBody=e,cn.transport=o,cn.status=t,cn.state=n,on()}function Z(e,n){if(n.readResponsesHeaders)try{var o=e.getResponseHeader("X-Cache-Date");o&&null!=o&&o.length>0&&(n.lastTimestamp=o.split(" ").pop());var r=e.getResponseHeader("X-Atmosphere-tracking-id");r&&null!=r&&(n.uuid=r.split(" ").pop())}catch(i){}else n.enableProtocol||(n.lastTimestamp=t.util.now(),n.uuid=yn)}function en(e){nn(e,ln),nn(e,t.util)}function nn(e,n){switch(e.state){case"messageReceived":hn=0,"undefined"!=typeof n.onMessage&&n.onMessage(e);break;case"error":"undefined"!=typeof n.onError&&n.onError(e);break;case"opening":delete ln.closed,"undefined"!=typeof n.onOpen&&n.onOpen(e);break;case"messagePublished":"undefined"!=typeof n.onMessagePublished&&n.onMessagePublished(e);break;case"re-connecting":"undefined"!=typeof n.onReconnect&&n.onReconnect(ln,e);break;case"closedByClient":"undefined"!=typeof n.onClientTimeout&&n.onClientTimeout(ln);break;case"re-opening":delete ln.closed,"undefined"!=typeof n.onReopen&&n.onReopen(ln,e);break;case"fail-to-reconnect":"undefined"!=typeof n.onFailureToReconnect&&n.onFailureToReconnect(ln,e);break;case"unsubscribe":case"closed":var t="undefined"!=typeof ln.closed?ln.closed:!1;"undefined"==typeof n.onClose||t||n.onClose(e),ln.closed=!0}}function tn(e){"closed"!==cn.state&&(cn.state="closed",cn.responseBody="",cn.messages=[],cn.status=e?200:501,on())}function on(){var e=function(e,n){n(cn)};null==wn&&null!=bn&&bn(cn.responseBody),ln.reconnect=ln.mrequest;for(var n="string"==typeof cn.responseBody,o=n&&ln.trackMessageLength?cn.messages.length>0?cn.messages:[""]:new Array(cn.responseBody),i=0;i<o.length;i++)if(!(o.length>1&&0===o[i].length)&&(cn.responseBody=n?t.util.trim(o[i]):o[i],null==wn&&null!=bn&&bn(cn.responseBody),0!==cn.responseBody.length||"messageReceived"!==cn.state)){if(en(cn),r.length>0){"debug"===ln.logLevel&&t.util.debug("Invoking "+r.length+" global callbacks: "+cn.state);try{t.util.each(r,e)}catch(a){t.util.log(ln.logLevel,["Callback exception"+a])}}if("function"==typeof ln.callback){"debug"===ln.logLevel&&t.util.debug("Invoking request callbacks");try{ln.callback(cn)}catch(a){t.util.log(ln.logLevel,["Callback exception"+a])}}}}var rn,an,sn,ln={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,onError:function(){},onClose:function(){},onOpen:function(){},onMessage:function(){},onReopen:function(){},onReconnect:function(){},onMessagePublished:function(){},onTransportFailure:function(){},onLocalMessage:function(){},onFailureToReconnect:function(){},onClientTimeout:function(){}},cn={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1},un=null,dn=null,fn=null,pn=null,gn=null,mn=!0,hn=0,vn=!1,bn=null,wn=null,yn=t.util.now();f(e),this.subscribe=function(e){f(e),m()},this.execute=function(){m()},this.close=function(){c()},this.disconnect=function(){l()},this.getUrl=function(){return ln.url},this.push=function(e,n){if(null!=n){var t=ln.dispatchUrl;ln.dispatchUrl=n,j(e),ln.dispatchUrl=t}else j(e)},this.getUUID=function(){return ln.uuid},this.pushLocal=function(e){W(e)},this.enableProtocol=function(){return ln.enableProtocol},this.request=ln,this.response=cn}},t.subscribe=function(e,n,r){"function"==typeof n&&t.addCallback(n),"string"!=typeof e?r=e:r.url=e,i="undefined"!=typeof r&&"undefined"!=typeof r.uuid?r.uuid:0;var a=new t.AtmosphereRequest(r);return a.execute(),o[o.length]=a,a},t.unsubscribe=function(){if(o.length>0)for(var e=[].concat(o),n=0;n<e.length;n++){var t=e[n];t.close(),clearTimeout(t.response.request.id)}o=[],r=[]},t.unsubscribeUrl=function(e){var n=-1;if(o.length>0)for(var t=0;t<o.length;t++){var r=o[t];if(r.getUrl()===e){r.close(),clearTimeout(r.response.request.id),n=t;break}}n>=0&&o.splice(n,1)},t.addCallback=function(e){-1===t.util.inArray(e,r)&&r.push(e)},t.removeCallback=function(e){var n=t.util.inArray(e,r);-1!==n&&r.splice(n,1)},t.util={browser:{},parseHeaders:function(e){for(var n,t=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,o={};n=t.exec(e);)o[n[1]]=n[2];return o},now:function(){return(new Date).getTime()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},inArray:function(e,n){if(!Array.prototype.indexOf){for(var t=n.length,o=0;t>o;++o)if(n[o]===e)return o;return-1}return n.indexOf(e)},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getAbsoluteURL:function(e){var n=document.createElement("div");return n.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(n.firstChild.href))},prepareURL:function(e){var n=t.util.now(),o=e.replace(/([?&])_=[^&]*/,"$1_="+n);return o+(o===e?(/\?/.test(e)?"&":"?")+"_="+n:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(e){function n(e,n){n=t.util.isFunction(n)?n():null==n?"":n,i.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}function o(e,r){var i;if(t.util.isArray(r))t.util.each(r,function(t,r){/\[\]$/.test(e)?n(e,r):o(e+"["+("object"==typeof r?t:"")+"]",r)});else if("[object Object]"===Object.prototype.toString.call(r))for(i in r)o(e+"["+i+"]",r[i]);else n(e,r)}var r,i=[];for(r in e)o(r,e[r]);return i.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(e){return!1}},iterate:function(e,n){var t;return n=n||0,function o(){t=setTimeout(function(){e()!==!1&&o()},n)}(),function(){clearTimeout(t)}},each:function(e,n,o){if(e){var r,i=0,a=e.length,s=t.util.isArray(e);if(o){if(s)for(;a>i&&(r=n.apply(e[i],o),r!==!1);i++);else for(i in e)if(r=n.apply(e[i],o),r===!1)break}else if(s)for(;a>i&&(r=n.call(e[i],i,e[i]),r!==!1);i++);else for(i in e)if(r=n.call(e[i],i,e[i]),r===!1)break;
    return e}},extend:function(e){var n,t,o;for(n=1;n<arguments.length;n++)if(null!=(t=arguments[n]))for(o in t)e[o]=t[o];return e},on:function(e,n,t){e.addEventListener?e.addEventListener(n,t,!1):e.attachEvent&&e.attachEvent("on"+n,t)},off:function(e,n,t){e.removeEventListener?e.removeEventListener(n,t,!1):e.detachEvent&&e.detachEvent("on"+n,t)},log:function(e,n){if(window.console){var t=window.console[e];"function"==typeof t&&t.apply(window.console,n)}},warn:function(){t.util.log("warn",arguments)},info:function(){t.util.log("info",arguments)},debug:function(){t.util.log("debug",arguments)},error:function(){t.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}},parseJSON:function(e){return e?window.JSON&&window.JSON.parse?window.JSON.parse(e):new Function("return "+e)():null},stringifyJSON:function(e){function n(e){return'"'+e.replace(o,function(e){var n=r[e];return"string"==typeof n?n:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function t(e){return 10>e?"0"+e:e}var o=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,r={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):function i(e,o){var r,s,l,c,u=o[e],d=typeof u;switch(u&&"object"==typeof u&&"function"==typeof u.toJSON&&(u=u.toJSON(e),d=typeof u),d){case"string":return n(u);case"number":return isFinite(u)?String(u):"null";case"boolean":return String(u);case"object":if(!u)return"null";switch(Object.prototype.toString.call(u)){case"[object Date]":return isFinite(u.valueOf())?'"'+u.getUTCFullYear()+"-"+t(u.getUTCMonth()+1)+"-"+t(u.getUTCDate())+"T"+t(u.getUTCHours())+":"+t(u.getUTCMinutes())+":"+t(u.getUTCSeconds())+'Z"':"null";case"[object Array]":for(l=u.length,c=[],r=0;l>r;r++)c.push(i(r,u)||"null");return"["+c.join(",")+"]";default:c=[];for(r in u)a.call(u,r)&&(s=i(r,u),s&&c.push(n(r)+":"+s));return"{"+c.join(",")+"}"}}}("",{"":e})},checkCORSSupport:function(){if(t.util.browser.msie&&!window.XDomainRequest&&+t.util.browser.version.split(".")[0]<11)return!0;if(t.util.browser.opera&&+t.util.browser.version.split(".")<12)return!0;if("KreaTVWebKit/531"===t.util.trim(navigator.userAgent).slice(0,16))return!0;if("kreatel"===t.util.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var e=navigator.userAgent.toLowerCase(),n=e.indexOf("android")>-1;return n?!0:!1}},e=t.util.now(),function(){var e=navigator.userAgent.toLowerCase(),n=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];t.util.browser[n[1]||""]=!0,t.util.browser.version=n[2]||"0",t.util.browser.trident&&(t.util.browser.msie=!0),(t.util.browser.msie||t.util.browser.mozilla&&1===+t.util.browser.version.split(".")[0])&&(t.util.storage=!1)}(),t.util.on(window,"unload",function(){t.unsubscribe()}),t.util.on(window,"keypress",function(e){(27===e.charCode||27===e.keyCode)&&e.preventDefault&&e.preventDefault()}),t.util.on(window,"offline",function(){t.unsubscribe()}),t});